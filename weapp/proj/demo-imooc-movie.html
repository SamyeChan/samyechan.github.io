<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Demo | 电影imooc_云开发</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.cd5c72c6.css" as="style"><link rel="preload" href="/assets/js/app.eeafed04.js" as="script"><link rel="preload" href="/assets/js/2.afbf9380.js" as="script"><link rel="prefetch" href="/assets/js/10.2e1b7492.js"><link rel="prefetch" href="/assets/js/11.072b1ec5.js"><link rel="prefetch" href="/assets/js/12.a114e3a6.js"><link rel="prefetch" href="/assets/js/13.5d97b8ed.js"><link rel="prefetch" href="/assets/js/14.af0ec100.js"><link rel="prefetch" href="/assets/js/15.4fc5926f.js"><link rel="prefetch" href="/assets/js/16.42e70420.js"><link rel="prefetch" href="/assets/js/17.c421b56c.js"><link rel="prefetch" href="/assets/js/18.a1ffefe7.js"><link rel="prefetch" href="/assets/js/19.ee1da8cc.js"><link rel="prefetch" href="/assets/js/20.77e29b77.js"><link rel="prefetch" href="/assets/js/21.9a513871.js"><link rel="prefetch" href="/assets/js/22.e55c0db0.js"><link rel="prefetch" href="/assets/js/23.fd5d7d0e.js"><link rel="prefetch" href="/assets/js/24.13a669c5.js"><link rel="prefetch" href="/assets/js/25.425380b9.js"><link rel="prefetch" href="/assets/js/26.6dfdd324.js"><link rel="prefetch" href="/assets/js/27.0937fed6.js"><link rel="prefetch" href="/assets/js/28.bfb0b483.js"><link rel="prefetch" href="/assets/js/29.49957e12.js"><link rel="prefetch" href="/assets/js/3.0c232385.js"><link rel="prefetch" href="/assets/js/30.acbaaf58.js"><link rel="prefetch" href="/assets/js/31.21a3adad.js"><link rel="prefetch" href="/assets/js/32.d038dc64.js"><link rel="prefetch" href="/assets/js/33.d9e5eea0.js"><link rel="prefetch" href="/assets/js/34.b48cb135.js"><link rel="prefetch" href="/assets/js/35.98e9936d.js"><link rel="prefetch" href="/assets/js/36.fac903a8.js"><link rel="prefetch" href="/assets/js/37.d5297412.js"><link rel="prefetch" href="/assets/js/38.176f58af.js"><link rel="prefetch" href="/assets/js/39.c38a5176.js"><link rel="prefetch" href="/assets/js/4.9fb4a8e1.js"><link rel="prefetch" href="/assets/js/40.1bbf90a0.js"><link rel="prefetch" href="/assets/js/41.e3d3f973.js"><link rel="prefetch" href="/assets/js/42.28aa8454.js"><link rel="prefetch" href="/assets/js/43.42e01315.js"><link rel="prefetch" href="/assets/js/44.27db6af7.js"><link rel="prefetch" href="/assets/js/45.ce6a3a05.js"><link rel="prefetch" href="/assets/js/46.6cb6650d.js"><link rel="prefetch" href="/assets/js/47.ac7471ee.js"><link rel="prefetch" href="/assets/js/48.213c97e3.js"><link rel="prefetch" href="/assets/js/49.52e280fd.js"><link rel="prefetch" href="/assets/js/5.9fa0fa23.js"><link rel="prefetch" href="/assets/js/50.d516b96c.js"><link rel="prefetch" href="/assets/js/51.e2ee8c82.js"><link rel="prefetch" href="/assets/js/52.725fe410.js"><link rel="prefetch" href="/assets/js/53.ebd011cc.js"><link rel="prefetch" href="/assets/js/54.fde9837e.js"><link rel="prefetch" href="/assets/js/55.ce8d57e3.js"><link rel="prefetch" href="/assets/js/56.594a608b.js"><link rel="prefetch" href="/assets/js/57.61f10426.js"><link rel="prefetch" href="/assets/js/58.e1138ed6.js"><link rel="prefetch" href="/assets/js/59.eb06b6ea.js"><link rel="prefetch" href="/assets/js/6.7ad30404.js"><link rel="prefetch" href="/assets/js/60.b36c0267.js"><link rel="prefetch" href="/assets/js/61.812cb1e3.js"><link rel="prefetch" href="/assets/js/62.1ea99e63.js"><link rel="prefetch" href="/assets/js/63.106718fc.js"><link rel="prefetch" href="/assets/js/64.cb98fff7.js"><link rel="prefetch" href="/assets/js/65.b44cd27b.js"><link rel="prefetch" href="/assets/js/66.1994a956.js"><link rel="prefetch" href="/assets/js/67.5148b41e.js"><link rel="prefetch" href="/assets/js/68.e0479229.js"><link rel="prefetch" href="/assets/js/69.2d498648.js"><link rel="prefetch" href="/assets/js/7.698e756a.js"><link rel="prefetch" href="/assets/js/70.725fb664.js"><link rel="prefetch" href="/assets/js/71.2b12411c.js"><link rel="prefetch" href="/assets/js/72.22a5d1f9.js"><link rel="prefetch" href="/assets/js/8.3b103cff.js"><link rel="prefetch" href="/assets/js/9.75d3bd5f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cd5c72c6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">快速跳转</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue/learn-basic.html" class="nav-link">Vue</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">快速跳转</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue/learn-basic.html" class="nav-link">Vue</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>起始</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>公众号/小程序</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/weapp/wechat.html" class="sidebar-link">Basic | 公众号开发</a></li><li><a href="/weapp/basic/learn-weapp-basic.html" class="sidebar-link">Learn | 基础</a></li><li><a href="/weapp/basic/learn-weapp-component.html" class="sidebar-link">Learn | 组件</a></li><li><a href="/weapp/basic/learn-weapp-api.html" class="sidebar-link">Learn | API</a></li><li><a href="/weapp/basic/learn-weapp-cloud.html" class="sidebar-link">Learn | 云开发</a></li><li><a href="/weapp/basic/learn-wechat-dev.html" class="sidebar-link">Learn | node微信开发</a></li><li><a href="/weapp/proj/demo-imooc-movie.html" class="active sidebar-link">Demo | 电影imooc_云开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/weapp/proj/demo-imooc-movie.html#_00-碎碎念" class="sidebar-link">00 碎碎念</a></li><li class="sidebar-sub-header"><a href="/weapp/proj/demo-imooc-movie.html#_01-电影主页" class="sidebar-link">01 电影主页</a></li><li class="sidebar-sub-header"><a href="/weapp/proj/demo-imooc-movie.html#_02-电影详情页" class="sidebar-link">02 电影详情页</a></li><li class="sidebar-sub-header"><a href="/weapp/proj/demo-imooc-movie.html#_03-个人信息页" class="sidebar-link">03 个人信息页</a></li><li class="sidebar-sub-header"><a href="/weapp/proj/demo-imooc-movie.html#_04-小结" class="sidebar-link">04 小结</a></li></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>HTML</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>阅读理解</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>其他辅助</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="demo-电影imooc-云开发"><a href="#demo-电影imooc-云开发" aria-hidden="true" class="header-anchor">#</a> Demo | 电影imooc_云开发</h1> <h2 id="_00-碎碎念"><a href="#_00-碎碎念" aria-hidden="true" class="header-anchor">#</a> 00 碎碎念</h2> <p>昂昂昂...从去年说要学小程序，到今天五月份了，还在入门的门外阶段，感觉自己真.拖.延.最近没有项目也没有了demo，余下了一片时间，嗯，it's time to say hello, weapp =_+</p> <p>于是乎...我就去慕课学习了啊，还是不够爱学习，一如既往点击了“免费课程”：<a href="https://www.imooc.com/learn/1121" target="_blank" rel="noopener noreferrer">《轻松入门微信小程序与云开发》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，其实老师讲得还是不错的，助我入了门？！</p> <p>课程主要分成了三部分 = 小程序基础 + 云开发 + 电影demo，一贯的学习结构。其实这个课程一两天就能完全地走一遍的，然鹅...微信小程序开发工具没有Linux版本，但我就是倔(lan)，不想安虚拟机，和Centos搏斗了一二三天，终于看见了nice的界面啊～哈哈哈，虽然行为有点蠢，但蠢蠢地蛮有成就感呢～</p> <p>附上大佬GitHub：<a href="https://github.com/cytle/wechat_web_devtools" target="_blank" rel="noopener noreferrer">微信开发者工具Linux完美支持<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，以及万分的感谢～</p> <hr> <p>碎碎念了一堆没用的，还是得来点和demo相关的口水滴 +_=</p> <p>小程序基础学习部分已(zhun)经(bei)写在上面的文中了，so...这一页就留给了我的第一个小程序demo上了啊。</p> <p><strong>整个demo由三个页面组成 = 首页 + 详情页 + 用户页</strong>，简单涉及了下面几个部分：</p> <ul><li>wxml、wxss编写页面；</li> <li>云函数编写 + api请求 + 数据获取；</li> <li>下拉加载效果 + 加载提示；</li> <li>模糊背景；</li> <li>组件库的引入 + 使用；</li> <li>图片上传 + 评价提交 + 数据库使用；</li> <li>用户信息获取；</li></ul> <hr> <p>昂昂昂，那么 Let's GO！</p> <h2 id="_01-电影主页"><a href="#_01-电影主页" aria-hidden="true" class="header-anchor">#</a> 01 电影主页</h2> <p>功能点：</p> <ol><li><a href="#API">豆瓣api数据获取 + 数据展示</a>；</li> <li><a href="#UP_LOAD">下拉加载数据</a>；</li> <li><a href="#LOADING">加载提示信息</a>；</li> <li><a href="#JUMP_TO">页面跳转</a>；</li></ol> <p>实现效果：</p> <p><img src="/assets/img/imooc-movie-index.cfb65851.gif" alt="电影主页"></p> <h3 id="请求数据-云函数"><a href="#请求数据-云函数" aria-hidden="true" class="header-anchor">#</a> <a name="API">请求数据 | 云函数</a></h3> <ol><li>首先，得给请求一片发挥的天地～～来，一起 <strong>新建一个云函数</strong>：</li></ol> <p><img src="/assets/img/imooc-movie-newcloudfunc.990e229b.gif" alt="新建云函数"></p> <ul><li>云函数文件夹下 <code>右键</code>，选择 <code>“新建Node.js云函数”</code>；</li> <li>输入云函数名称（中文不可取名噢，所以gif报错了啊）；</li> <li>谨记：一定要 <code>”创建并部署：xxxx“</code> 哟；</li></ul> <ol start="2"><li>接着呢，因为这个demo是通过云(fu)函(wu)数(duan)发送的请求，所以要用一用第三方库 <a href="https://github.com/request/request-promise" target="_blank" rel="noopener noreferrer">request-promise<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>～</li></ol> <p>我们在上面新建的云函数文件夹右键选择 <code>在终端中打开</code>，进入终端界面，依次输入：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> --save request
<span class="token function">npm</span> <span class="token function">install</span> --save request-promise
</code></pre></div><ol start="3"><li>在新建云函数的 index.js文件中使用 <code>request-promise</code> 发送请求：</li></ol> <ul><li>此处奉上 <a href="https://douban-api-docs.zce.me/" target="_blank" rel="noopener noreferrer">豆瓣开放api文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 云函数入口文件</span>
<span class="token keyword">const</span> cloud <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'wx-server-sdk'</span><span class="token punctuation">)</span>
<span class="token comment">// 初始化</span>
cloud<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 引入第三方库 request-promise (***)</span>
<span class="token keyword">var</span> rp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'request-promise'</span><span class="token punctuation">)</span>
<span class="token comment">// 云函数入口函数</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 接入豆瓣api (***)</span>
  <span class="token keyword">return</span> <span class="token function">rp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`http://api.douban.com/v2/movie/in_theaters?apikey=0df993c66c0c636e29ecbb5344252a4a&amp;start=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>start<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;count=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
    <span class="token comment">// 熟悉的promise写法 - then &amp; catch </span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span> <span class="token comment">// 返回数据</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录错误</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li><p>写完云函数逻辑，记得 <strong>部署云函数</strong> ！！</p></li> <li><p>最后就是在相关页面的js文件中引用上述的云函数啦～ <code>wx.cloud.callFunction</code>。</p></li></ol> <p>小程序初始化的js文件中预定义了很多类生命周期函数，电影列表的数据加载应放在页面加载之时，如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 页面的初始数据
 */</span>
data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  movieList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 电影列表</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">/**
 * 生命周期函数--监听页面加载
 */</span>
<span class="token function-variable function">onLoad</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  wx<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span><span class="token function">callFunction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">'movielist'</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      start<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      count<span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      movieList<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>movieList
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="下拉加载"><a href="#下拉加载" aria-hidden="true" class="header-anchor">#</a> <a name="UP_LOAD">下拉加载</a></h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 获取数据列表（写在一个方法中，方便后续调用于不同的地方）</span>
<span class="token function-variable function">getMovieList</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  wx<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span><span class="token function">callFunction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">'movielist'</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// 每次请求时的起点应该就是列表长度</span>
      start<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>movieList<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
      count<span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 每次获取数据后应该将它拼接在数据后面 - concat()连接两个或多个数组</span>
      movieList<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>movieList<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span>subjects<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token comment">/**
 * 页面上拉触底事件的处理函数
 */</span>
<span class="token function-variable function">onReachBottom</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMovieList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="加载信息提示信息"><a href="#加载信息提示信息" aria-hidden="true" class="header-anchor">#</a> <a name="LOADING">加载信息提示信息</a></h3> <p><code>wx.showLoading</code> &amp; <code>wx.hideLoading</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 添加加载信息</span>
wx<span class="token punctuation">.</span><span class="token function">showLoading</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  title<span class="token punctuation">:</span> <span class="token string">'加载中...'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 移除加载信息</span>
wx<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="跳转页面"><a href="#跳转页面" aria-hidden="true" class="header-anchor">#</a> <a name="JUMP_TO">跳转页面</a></h3> <p><code>wxml</code> 代码：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span>
  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>movie-comment<span class="token punctuation">'</span></span>
  <span class="token attr-name">bindtap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>toComment<span class="token punctuation">'</span></span>
  <span class="token attr-name">data-movieid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{item.id}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>评价<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li><code>bindtap</code>：绑定事件；</li> <li><code>data-xxx</code>：自定义传递参数；</li></ul> <p>逻辑代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 跳转至评价页面</span>
<span class="token function-variable function">toComment</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  wx<span class="token punctuation">.</span><span class="token function">navigateTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    url<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`../comment/comment?movieid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>movieid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>自定义参数的取用：<code>${event.target.dataset.xxx}</code></li></ul> <h2 id="_02-电影详情页"><a href="#_02-电影详情页" aria-hidden="true" class="header-anchor">#</a> 02 电影详情页</h2> <p>功能点：</p> <ol><li><a href="#MASK">电影模糊背景效果</a>；</li> <li><a href="#VANT">vant组件库的使用</a>；</li> <li><a href="#VANT_USE">评价框 + 星级评分</a>；</li> <li><a href="#UP_IMG">图片上传</a>；</li> <li><a href="#COMMIT">评价提交</a>；</li></ol> <p>实现效果：</p> <p><img src="/assets/img/imooc-movie-detail.2bd566ea.gif" alt="电影详情页"></p> <h3 id="背景模糊"><a href="#背景模糊" aria-hidden="true" class="header-anchor">#</a> <a name="MASK">背景模糊</a></h3> <p>背景模糊的效果其实就是，将电影海报的这个图片也当作整个电影基础信息框的背景图片，并且有一定的“高斯模糊”效果，如图：</p> <p><img src="/assets/img/imooc-movie-mask.518e3be3.png" alt="背景模糊"></p> <p>这个效果完全由CSS实现，而它的页面结构如下：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 模糊背景图片 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span>
  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>detail-container<span class="token punctuation">'</span></span><span class="token style-attr language-css"><span class="token attr-name">
  <span class="token attr-name">style</span></span><span class="token punctuation">='</span><span class="token attr-value"><span class="token property">background</span><span class="token punctuation">:</span> <span class="token url">url({{detail.images.large}})</span> no-repeat top/cover</span><span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 模糊北京图片遮罩层 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>detail-mask<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>设置2个 <code>view</code> 标签，一个放背景图并添加模糊效果，一个做底层（因为背景层设置了透明度呐）：</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token comment">/* 模糊背景图片 */</span>
<span class="token selector">.detail-container</span> <span class="token punctuation">{</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 400rpx<span class="token punctuation">;</span>
  <span class="token comment">/* 背景模糊 - filter滤镜属性：blur()高斯模糊 */</span>
  <span class="token comment">/* blur值一般以px为单位，可以理解为“近视眼以这个距离看图片” */</span>
  <span class="token property">filter</span><span class="token punctuation">:</span> <span class="token function">blur</span><span class="token punctuation">(</span>40rpx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* 设置透明度，使图片可显 */</span>
  <span class="token property">opacity</span><span class="token punctuation">:</span> .4<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* 模糊背景图片遮罩层：定位遮罩层，zindex:-1遮罩层位于底层 */</span>
<span class="token selector">.detail-mask</span> <span class="token punctuation">{</span>
  <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 400rpx<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #333<span class="token punctuation">;</span>
  <span class="token property">top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">z-index</span><span class="token punctuation">:</span> -1<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="小程序引入第三方组件库"><a href="#小程序引入第三方组件库" aria-hidden="true" class="header-anchor">#</a> <a name="VANT">小程序引入第三方组件库</a></h3> <ol><li>安装第三方组件库前的基础设置：</li></ol> <ul><li>在终端打开 <code>miniprogram</code>文件夹：</li></ul> <p><img src="/assets/img/imooc-movie-cmd.f71ec875.gif" alt="在终端中打开，并运行初始化代码"></p> <ul><li>在其下初始化一个文件 <code>package.json</code>（作用：基本信息配置及相关依赖包的管理），并做好相关设置：</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> init
</code></pre></div><ul><li>按照官方命令安装对应的包：</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i vant-weapp -S
</code></pre></div><ul><li><strong>构建npm</strong>：</li></ul> <p><img src="/assets/img/imooc-movie-npm.1f0f5ba9.gif" alt="构建npm"></p> <p>构建完成后 <code>miniprogram</code>文件夹下会多出来一个叫 <code>miniprogram_npm</code> 的包，里面就放置着上一步所安装的组件库啦～～</p> <ul><li>最后的关键一步！<code>详情</code> 中勾选 <code>使用npm模块</code>：</li></ul> <p><img src="/assets/img/imooc-movie-checkout.f02ed97b.gif" alt="勾选使用npm模块"></p> <p><strong>只有勾选以后，第三方的组件库才能起作用哟</strong></p> <h3 id="评价-评分"><a href="#评价-评分" aria-hidden="true" class="header-anchor">#</a> <a name="VANT_USE">评价 + 评分</a></h3> <p>电影详情页中的评价与评分界面都是引用的 <code>vant</code> 组件，都需要在页面文件夹下的 <code>xxx.json</code> 文件中写引用：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;usingComponents&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;van-field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/vant-weapp/field/&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;van-rate&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/vant-weapp/rate/&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;van-button&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/vant-weapp/button/&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>写评价和星级评分的功能完全借用的组件库中的 <code>Field 输入框</code> 和 <code>Rate 评分</code>，二者实现类似：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 评价部分 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>van-field</span>
  <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{ comment }}<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>写一些评价吧<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name"><span class="token namespace">bind:</span>change</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>onConentChange<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token comment">&lt;!-- 星级评分 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>van-rate</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{ score}}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">bind:</span>change</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>onScoreChange<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>绑定相应变量，但这不像Vue，不是超方便的非双向绑定，所以要在内容变化时定义一个方法来时时赋值给定义的变量～</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 页面的初始数据
 */</span>
data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  content<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// 评价内容</span>
  score<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">// 评价分数</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token comment">// 评论</span>
<span class="token function-variable function">onConentChange</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    content<span class="token punctuation">:</span> event<span class="token punctuation">.</span>detail
    <span class="token comment">// 这个detail是vant组件中自定义的，或取到组件返回的相应用户输入</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token comment">// 评分</span>
<span class="token function-variable function">onScoreChange</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    score<span class="token punctuation">:</span> event<span class="token punctuation">.</span>detail
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="图片上传-预览"><a href="#图片上传-预览" aria-hidden="true" class="header-anchor">#</a> <a name="UP_IMG">图片上传 + 预览</a></h3> <h4 id="图片上传"><a href="#图片上传" aria-hidden="true" class="header-anchor">#</a> 图片上传</h4> <p>图片上传的功能其实就是给一个普通加特效=_=，绑定一个 <code>uploadImg</code> 方法让它变得迷人极了:</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 图片上传 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>van-button</span>
    <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>warning<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">bindtap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>uploadImg<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>上传图片<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>van-button</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>让按钮变身的神奇托尼，是小程序自提供的API，小法子 <code>wx.chooseImage</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code>data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  images<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 上传的图片</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// 图片上传</span>
<span class="token function-variable function">uploadImg</span><span class="token punctuation">:</span>  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 选择图片（api）</span>
  wx<span class="token punctuation">.</span><span class="token function">chooseImage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// 图片上传个数</span>
    count<span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
    <span class="token comment">// 图片是否进行压缩</span>
    sizeType<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'original'</span><span class="token punctuation">,</span> <span class="token string">'compressed'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// 图片来源</span>
    sourceType<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'album'</span><span class="token punctuation">,</span> <span class="token string">'camera'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// 图片上传成功后执行的回调函数</span>
    <span class="token function-variable function">success</span><span class="token punctuation">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// tempFilePath可以作为img标签的src属性显示图片 - 一个临时路径</span>
      <span class="token keyword">const</span> tempFilePaths <span class="token operator">=</span> res<span class="token punctuation">.</span>tempFilePaths
      <span class="token comment">// 赋值</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          images<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>images<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>tempFilePaths<span class="token punctuation">)</span>
          <span class="token comment">// 记得concat一下哈</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>wx.chooseImage</code> 提供了选择参数基本满足大部分需求，我们只需要按需设置，最后都是 -- “取东西赋值”。</p> <h4 id="图片预览"><a href="#图片预览" aria-hidden="true" class="header-anchor">#</a> 图片预览</h4> <p>昂，图片的预览其实就是一个数据的循环显示了，将图片显示出来以后，再用css魔法打扮一下，ok～</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 图片预览 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span>
    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>comment-img<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{item}}<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">wx:</span>for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{images}}<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">wx:</span>key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{index}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="评价提交"><a href="#评价提交" aria-hidden="true" class="header-anchor">#</a> <a name="COMMIT">评价提交</a></h3> <p>评价提交就是将上面拿到的所有数据存到云数据库当中，那么首先，你就得有一个云数据库集合啦 +.+</p> <p><img src="/assets/img/imooc-movie-create-db.607059e5.gif" alt="新建集合"></p> <p>接着敲！代！码！万能的 button 又上场：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 评价提交 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>van-button</span>
  <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>danger<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>large<span class="token punctuation">'</span></span>
  <span class="token attr-name">bindtap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>submit<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>提交评价<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>van-button</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>蓝后，就是大片的逻辑代码了，涉及到了一个异步问题，所以需要请出 <code>Promise</code> 大佬：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 提交评价</span>
<span class="token function-variable function">submit</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 加载提示</span>
  wx<span class="token punctuation">.</span><span class="token function">showLoading</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> <span class="token string">'评价中...'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 上传图片到云存储</span>
  <span class="token keyword">let</span> promiseArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>images<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    promiseArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> item <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>images<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 正则表达式，返回文件扩展名</span>
      <span class="token keyword">let</span> suffix <span class="token operator">=</span> <span class="token regex">/\.\w+$/</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 云函数提供API</span>
      wx<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">// 上传至云端的路径</span>
        cloudPath<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> suffix<span class="token punctuation">,</span>
        <span class="token comment">// 小程序临时文件路径</span>
        filePath<span class="token punctuation">:</span> item<span class="token punctuation">,</span>
        <span class="token comment">// 成功</span>
        <span class="token function-variable function">success</span><span class="token punctuation">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 返回文件id</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              fileIds<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fileIds<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>fileID<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// 失败</span>
        fail<span class="token punctuation">:</span> console<span class="token punctuation">.</span>error
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 当所有处理都成功执行后才执行（即所有图片均成功上传）</span>
  Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promiseArr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 要将数据存在名为 comment 的数据库中</span>
    db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'comment'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 需要存于云数据库的数据</span>
      data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        content<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
        score<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>score<span class="token punctuation">,</span>
        movieId<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>movieId<span class="token punctuation">,</span>
        fileIds<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fileIds
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      wx<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 移除加载提示</span>
      wx<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    <span class="token comment">// 添加操作提示</span>
        title<span class="token punctuation">:</span> <span class="token string">'评价成功！'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      wx<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      wx<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        title<span class="token punctuation">:</span> <span class="token string">'评价失败...,'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div> <h2 id="_03-个人信息页"><a href="#_03-个人信息页" aria-hidden="true" class="header-anchor">#</a> 03 个人信息页</h2> <h4 id="方法01"><a href="#方法01" aria-hidden="true" class="header-anchor">#</a> 方法01</h4> <p>使用小程序组件 <code>open-data</code>，其用于展示微信开放的数据，此处关注其中的 <code>type</code> 属性：</p> <table><thead><tr><th style="text-align:center">值</th> <th style="text-align:center">说明</th></tr></thead> <tbody><tr><td style="text-align:center">groupName</td> <td style="text-align:center">拉取群名称</td></tr> <tr><td style="text-align:center">userNickName</td> <td style="text-align:center">用户昵称</td></tr> <tr><td style="text-align:center">userAvatarUrl</td> <td style="text-align:center">用户头像</td></tr> <tr><td style="text-align:center">userGender</td> <td style="text-align:center">用户性别</td></tr> <tr><td style="text-align:center">userCity</td> <td style="text-align:center">用户所在城市</td></tr> <tr><td style="text-align:center">userProvince</td> <td style="text-align:center">用户所在省份</td></tr> <tr><td style="text-align:center">userCountry</td> <td style="text-align:center">用户所在国家</td></tr> <tr><td style="text-align:center">userLanguage</td> <td style="text-align:center">用户的语言</td></tr></tbody></table> <p><strong>简单使用</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>open-data</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>userAvatarUrl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>open-data</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="方法02"><a href="#方法02" aria-hidden="true" class="header-anchor">#</a> 方法02</h4> <p>利用小程序 <code>button</code> 组件中的 <code>open-type</code> 属性的 <code>getUserInfo</code>（获取用户信息，可以从bindgetuserinfo回调中获取到用户信息）：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span>
  <span class="token attr-name">open-type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>getUserInfo<span class="token punctuation">'</span></span>
  <span class="token attr-name">bindgetuserinfo</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>onGotUserInfo<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
    点击获取用户信息
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>实现效果：</p> <p><img src="/assets/img/imooc-movie-usrInfo.2c2b9b03.gif" alt="open-type"></p> <p>逻辑部分：（昂，虽然这里并无逻辑可言）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 获取当前用户信息</span>
<span class="token function-variable function">onGotUserInfo</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 打印获取到的用户信息</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看吧，拿到数据咯：</p> <p><img src="/assets/img/imooc-movie-res.9e35852d.png" alt="获取到的数据"></p> <h2 id="_04-小结"><a href="#_04-小结" aria-hidden="true" class="header-anchor">#</a> 04 小结</h2> <p>虽然这个demo很简单，但是终于让我入了门，还发现了云开发这么(bu)方(yao)便(qian)的方法，哎哎哎，自己还是只蛙啊，世界有意思可以学习的东西这么多，得努力地跳出去呐～</p> <blockquote><p>Do one thing and do it well.</p></blockquote></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/weapp/basic/learn-wechat-dev.html" class="prev">
          Learn | node微信开发
        </a></span> <span class="next"><a href="/html/">
          简述
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.eeafed04.js" defer></script><script src="/assets/js/2.afbf9380.js" defer></script>
  </body>
</html>
